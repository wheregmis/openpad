name: Openpad macOS Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      build_macos_14_aarch64:
        description: 'Build macOS 14 (Apple Silicon)'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag (required if creating release)'
        required: false
        type: string
        default: ''
      create_release:
        description: 'Create a GitHub Release'
        required: true
        type: boolean
        default: false
      pre_release:
        description: 'Mark as a pre-release'
        required: true
        type: boolean
        default: false

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check_tag_version:
    name: Check Release Tag and Cargo.toml Version Consistency
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Check tag and Cargo.toml version
        run: |
          TAG_REF="${GITHUB_REF##*/}"
          echo "Current tag: $TAG_REF"

          CARGO_MANIFEST_VERSION=$(cargo metadata --no-deps --format-version 1 --frozen --manifest-path openpad-app/Cargo.toml | jq -r '.packages[0].version')
          echo "openpad-app Cargo.toml version: $CARGO_MANIFEST_VERSION"

          if [[ "$TAG_REF" != "v$CARGO_MANIFEST_VERSION" ]]; then
            echo "Error: Tag '$TAG_REF' does not match Cargo.toml version '$CARGO_MANIFEST_VERSION'."
            echo "Please create a tag that matches the Cargo.toml version."
            exit 1
          else
            echo "Tag and Cargo.toml version are consistent."
          fi

  determine_matrices:
    name: Determine Build Matrix
    runs-on: ubuntu-latest
    outputs:
      macos_matrix: ${{ steps.set.outputs.macos_matrix }}
      run_macos: ${{ steps.set.outputs.run_macos }}
    steps:
      - name: Build matrix from inputs
        id: set
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          def truthy(value: str) -> bool:
              if value is None:
                  return False
              return str(value).strip().lower() == "true"

          event_name = os.environ.get("GITHUB_EVENT_NAME", "")
          inputs = {}
          event_path = os.environ.get("GITHUB_EVENT_PATH")
          if event_path and Path(event_path).exists():
              with open(event_path, "r", encoding="utf-8") as handle:
                  payload = json.load(handle)
              inputs = payload.get("inputs") or {}

          macos = []

          def add_macos(os_name: str, arch: str) -> None:
              macos.append({
                  "os": os_name,
                  "arch": arch,
                  "packager_formats": "dmg",
              })

          if event_name == "push":
              add_macos("macos-14", "aarch64")
          else:
              if truthy(inputs.get("build_macos_14_aarch64")):
                  add_macos("macos-14", "aarch64")

          outputs = {
              "macos_matrix": json.dumps({"include": macos}),
              "run_macos": "true" if macos else "false",
          }

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              for key, value in outputs.items():
                  handle.write(f"{key}={value}\n")
          PY

  create_release:
    name: Create Release
    needs: [check_tag_version, determine_matrices]
    if: >-
      ${{ always() && (
        (github.event_name == 'push' && needs.check_tag_version.result == 'success') ||
        (github.event_name == 'workflow_dispatch' &&
          github.event.inputs.create_release == 'true' &&
          needs.determine_matrices.outputs.run_macos == 'true'
        )
      ) }}
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_tag: ${{ steps.resolve.outputs.tag }}
      release_name: ${{ steps.resolve.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve release metadata
        id: resolve
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          def read_version(path: str) -> str:
              in_package = False
              for raw_line in Path(path).read_text(encoding="utf-8").splitlines():
                  line = raw_line.strip()
                  if line.startswith("[") and line.endswith("]"):
                      in_package = line == "[package]"
                      continue
                  if not in_package or not line.startswith("version"):
                      continue
                  _, value = line.split("=", 1)
                  value = value.strip().strip('"').strip("'")
                  if value:
                      return value
              return ""

          event_name = os.environ.get("GITHUB_EVENT_NAME", "")
          ref_name = os.environ.get("GITHUB_REF_NAME", "").strip()
          release_tag_input = os.environ.get("RELEASE_TAG", "").strip()
          version = read_version("openpad-app/Cargo.toml")

          if event_name == "push" and ref_name:
              tag = ref_name
              name = f"Openpad {ref_name}"
          else:
              if not version:
                  raise SystemExit("Unable to resolve Cargo.toml package version.")
              tag = release_tag_input or f"v{version}"
              tag = tag.replace("__VERSION__", version)
              name = f"Openpad v{version}"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"tag={tag}\n")
              handle.write(f"name={name}\n")
          PY
        env:
          RELEASE_TAG: ${{ github.event.inputs.release_tag }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.tag }}
          name: ${{ steps.resolve.outputs.name }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          prerelease: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.pre_release == 'true') || (github.event_name == 'push' && contains(github.ref, '-')) }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

  for_macos:
    name: Release Openpad for macOS (${{ matrix.os }}, ${{ matrix.arch }})
    needs: [check_tag_version, determine_matrices, create_release]
    if: ${{ always() && ((github.event_name == 'push' && needs.check_tag_version.result == 'success') || (github.event_name == 'workflow_dispatch' && needs.determine_matrices.outputs.run_macos == 'true')) }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_matrices.outputs.macos_matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Package (macos)
        uses: Project-Robius-China/makepad-packaging-action@main
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          packager_formats: ${{ matrix.packager_formats }}
          args: --manifest-path openpad-app/Cargo.toml
          releaseId: ${{ needs.create_release.outputs.release_id }}
